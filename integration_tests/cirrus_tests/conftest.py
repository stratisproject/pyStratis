import pytest
from typing import Union
from pystratis import api
from pystratis.api.smartcontracts.responsemodels import ReceiptModel
from pystratis.core.types import Address, Money, hexstr, uint32, uint64, uint128, uint256, int32, int64
from pystratis.core import SmartContractParameter, SmartContractParameterType
from pystratis.api.global_responsemodels import BuildContractTransactionModel, WalletSendTransactionModel
from pystratis.nodes import CirrusMinerNode, CirrusNode, BaseNode, CirrusUnity3DNode


@pytest.fixture(scope='package', autouse=True)
def initialize_nodes(
        start_cirrusminer_regtest_node,
        start_cirrus_regtest_node,
        cirrusminer_node,
        cirrusminerunity3d_node,
        cirrus_node,
        node_creates_a_wallet,
        send_a_transaction,
        get_node_address_with_balance,
        get_node_unused_address,
        connect_two_nodes,
        sync_two_nodes,
        get_federation_private_key,
        wait_and_clear_mempool,
        transfer_funds_to_test,
        balance_funds_across_nodes,
        fund_smartcontract_address,
        check_at_or_above_given_block_height,
        make_some_transactions_by_splitting,
        git_checkout_current_node_version):
    git_checkout_current_node_version(api.__version__)

    # Start two cirrus nodes on the same regtest network.
    cirrusminer_extra_cmd_ops_node_mining = ['-devmode=miner', '-mincoinmaturity=1', '-mindepositconfirmations=1', '-bantime=1']
    """
    Cirrusminer doesn't have unityapi enabled at this time. For unity3d testing, requires modifying the following to enable unity3d:
    1) src/Stratis.CirrusMinerD/Program.cs (enable unity3d api)
    2) src/Stratis.CirrusMinerD/Stratis.CirrusMinerD.csproj (add project reference)
    """
    cirrusminer_extra_cmd_ops_node_syncing = ['-devmode=miner', '-mincoinmaturity=1', '-mindepositconfirmations=1', '-bantime=1', '-unityapi_enable=1',
                                              f'-whitelist=127.0.0.1:{cirrusminer_node.blockchainnetwork.DEFAULT_PORT}',
                                              f'-unityapi_apiport={cirrusminerunity3d_node.blockchainnetwork.UNITY3D_PORT}'
                                              ]
    cirrus_extra_cmd_ops_node_syncing = ['-mincoinmaturity=1', '-mindepositconfirmations=1', '-bantime=1',
                                         f'-whitelist=127.0.0.1:{cirrusminer_node.blockchainnetwork.DEFAULT_PORT}']
    start_cirrusminer_regtest_node(cirrusminer_node, extra_cmd_ops=cirrusminer_extra_cmd_ops_node_mining, private_key=get_federation_private_key(0))
    assert node_creates_a_wallet(cirrusminer_node)
    # Delay starting 2nd node to give first a head start.
    while True:
        above_height = check_at_or_above_given_block_height(cirrusminer_node, 5)
        if above_height:
            break

    start_cirrusminer_regtest_node(cirrusminerunity3d_node, extra_cmd_ops=cirrusminer_extra_cmd_ops_node_syncing, private_key=get_federation_private_key(2))
    start_cirrus_regtest_node(cirrus_node, extra_cmd_ops=cirrus_extra_cmd_ops_node_syncing)

    # Check endpoints implemented for cirrusminer and cirrus node.
    assert cirrusminer_node.check_all_endpoints_implemented()
    assert cirrus_node.check_all_endpoints_implemented()

    # Set up wallets for the second node. Wallets need to be setup before mining or joining federation
    assert node_creates_a_wallet(cirrusminerunity3d_node)

    # Connect federation nodes
    assert connect_two_nodes(cirrusminer_node, cirrusminerunity3d_node)
    assert wait_and_clear_mempool()

    # Transfer the cirrusdev funds to the first node's wallet, balance the funds, and remove cirrusdev wallet from each.
    assert transfer_funds_to_test(cirrusminer_node)
    assert wait_and_clear_mempool()
    assert transfer_funds_to_test(cirrusminerunity3d_node)
    assert wait_and_clear_mempool()
    assert balance_funds_across_nodes(cirrusminer_node, cirrusminerunity3d_node)
    assert wait_and_clear_mempool()
    assert fund_smartcontract_address(cirrusminer_node)
    assert wait_and_clear_mempool()
    assert fund_smartcontract_address(cirrusminerunity3d_node)
    assert wait_and_clear_mempool()
    assert make_some_transactions_by_splitting(cirrusminer_node)
    assert wait_and_clear_mempool()
    assert make_some_transactions_by_splitting(cirrusminerunity3d_node)
    assert wait_and_clear_mempool()
    yield

    # Teardown
    assert cirrusminer_node.stop_node()
    assert cirrusminerunity3d_node.stop_node()
    assert cirrus_node.stop_node()


@pytest.fixture(scope='package')
def apitestcontract_bytecode() -> hexstr:
    """See https://github.com/TjadenFroyda/CirrusAPITestContract for source."""
    return hexstr('4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0102005C4BA6F50000000000000000E00022200B01300000120000000200000000000072310000002000000040000000000010002000000002000004000000000000000400000000000000006000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000203100004F000000000000000000000000000000000000000000000000000000004000000C000000043100001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000078110000002000000012000000020000000000000000000000000000200000602E72656C6F6300000C0000000040000000020000001400000000000000000000000000004000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005431000000000000480000000200050040230000C40D000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001330030084000000000000000203280600000A0202280700000A6F0800000A28030000060204280500000602052807000006020E042809000006020E05280B000006020E06280D000006020E07280F000006020E082811000006020E092813000006020E0A2815000006020E0B2817000006020E0C2819000006020E0D281B00000602167201000070281C000006262A4602280900000A72290000706F0A00000A2A4A02280900000A7229000070036F0B00000A2A4602280900000A72350000706F0C00000A2A4A02280900000A7235000070036F0D00000A2A4E02280900000A72470000706F0E00000A16912A0000133004001D00000001000011178D0F0000012516039C0A02280900000A7247000070066F0F00000A2A4602280900000A72590000706F1000000A2A4A02280900000A7259000070036F1100000A2A4602280900000A726B0000706F1200000A2A4A02280900000A726B000070036F1300000A2A4602280900000A72810000706F1400000A2A4A02280900000A7281000070036F1500000A2A4602280900000A72970000706F1600000A2A4A02280900000A7297000070036F1700000A2A4602280900000A72AB0000706F1800000A2A4A02280900000A72AB000070036F1900000A2A4602280900000A72C10000706F1A00000A2A4A02280900000A72C1000070036F1B00000A2A4602280900000A72D50000706F0A00000A2A4A02280900000A72D5000070036F0B00000A2A4602280900000A72ED0000706F0E00000A2A4A02280900000A72ED000070036F0F00000A2A4602280900000A72090100706F1C00000A2A4A02280900000A7209010070036F1D00000A2A4602280900000A72210100706F1E00000A2A4A02280900000A7221010070036F1F00000A2A001330040055000000020000117239010070038C10000001282000000A0A02280900000A06046F1300000A021201FE15030000021201037D010000041201047D0200000407280100002B72530100700602280900000A066F1200000A282200000A2A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000058050000237E0000C4050000BC04000023537472696E677300000000800A00006801000023555300E80B0000100000002347554944000000F80B0000CC01000023426C6F6200000000000000020000015715A201090A000000FA013300160000010000001200000003000000020000001C0000001C000000220000000500000002000000010000000D0000001A000000010000000200000001000000010000000000F30201000000000006002102AA0306006002AA0306000D0297030F00CA0300000A0050022D040A004B042D040A00C1012D040A0025042D040A0067012D040A0025012D040600B70138030A0041022D040A009A012D040A00E8012D0406009C0238030600700038030600DD02380306006F043803000000006F01000000000100010001001000590400001900010001000A011000E40200002D0001001D0006008304D3000600AF01D60050200000000086189103D9000100E0200000000086087D031B000E00F2200000000086088703EF000E0005210000000086081503F5000F0017210000000081082203F9000F002A210000000086087E02FE00100040210000000081088B020201100069210000000086084F03070111007B210000000081085C030B0111008E21000000008608BB0210011200A021000000008108CA0214011200B321000000008608150019011300C52100000000810824001D011300D821000000008608500022011400EA210000000081085E0001001400FD210000000086088A00260115000F2200000000810899002A0115002222000000008608C5002F0116003422000000008108D30033011600472200000000860801041B00170059220000000081081104EF0017006C220000000086088904380118007E220000000081089B043D0118009122000000008608430143011900A322000000008108530148011900B62200000000860801014E011A00C822000000008108110153011A00DC220000000086008F0159011B0000000100D501000002002F0300000300980200000400690300000500D902000006003300000007006C0000000800A80000000900E10000000A00210400000B00AD0400000C00630100000D00210100000100A10200000100A10200000100A10200000100A10200000100A10200000100A10200000100A10200000100A10200000100A10200000100A10200000100A10200000100A10200000100A10200000100760400000200AF01090091030100110091030600190091030A002900910306006100910306003100910310003100A3011600690072031B003100F90120007100EB0325007100F6032B0071000503320071000D0337007100D9033D007100E203480071003F034F007100470354007100A7025A007100B1025F0071000100650071000B006A0071003E007000710047007500710076007B007100800080007100B30086007100BC008B0071002D0191007100380197007100EB009E007100F600A40089004404B1003100EF02B70089004404C30021002B00C4012E000B0093012E0013009C012E001B00BB0143002300C4014300AB000200010000008B035F0100002603640100008F026801000060036C010000CE02700100002800740100006200780100009D007C010000D7008001000015045F0100009F048401000057018901000015018E0102000200030001000300030002000400050001000500050002000600070001000700070002000800090001000900090002000A000B0001000B000B0002000C000D0001000D000D0002000E000F0001000F000F0002001000110001001100110002001200130001001300130002001400150001001500150002001600170001001700170002001800190001001900190002001A001B0001001B001B000480000000000000000000000000000000004B040000040000000000000000000000CA0078010000000002000000000000000000000000002D0400000000030002004300BE0000000047657455496E7433320053657455496E743332006765745F5465737455496E743332007365745F5465737455496E743332007465737455496E74333200476574496E74333200536574496E743332006765745F54657374496E743332007365745F54657374496E7433320074657374496E7433320047657455496E7436340053657455496E743634006765745F5465737455496E743634007365745F5465737455496E743634007465737455496E74363400476574496E74363400536574496E743634006765745F54657374496E743634007365745F54657374496E7436340074657374496E7436340047657455496E743235360053657455496E74323536006765745F5465737455496E74323536007365745F5465737455496E74323536007465737455496E743235360047657455496E743132380053657455496E74313238006765745F5465737455496E74313238007365745F5465737455496E74313238007465737455496E74313238003C4D6F64756C653E0053797374656D2E507269766174652E436F72654C696200546573744D6574686F6400494D657373616765006765745F4D657373616765006D6573736167650056616C7565547970650049536D617274436F6E7472616374537461746500736D617274436F6E74726163745374617465004950657273697374656E745374617465006765745F50657273697374656E7453746174650044656275676761626C6541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500496E646578417474726962757465004465706C6F794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F5465737442797465007365745F54657374427974650074657374427974650076616C756500476574537472696E6700536574537472696E67006765745F54657374537472696E67007365745F54657374537472696E670074657374537472696E6700546573744D6573736167654C6F6700536D617274436F6E74726163742E646C6C00476574426F6F6C00536574426F6F6C006765745F54657374426F6F6C007365745F54657374426F6F6C0074657374426F6F6C0053797374656D00476574436861720053657443686172006765745F5465737443686172007365745F5465737443686172007465737443686172006765745F53656E646572006765745F4F776E6572007365745F4F776E6572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F64657300476574427974657300536574427974657300476574416464726573730053657441646472657373006765745F5465737441646472657373007365745F546573744164647265737300746573744164647265737300537472617469732E536D617274436F6E74726163747300466F726D617400536D617274436F6E74726163740043697272757341504954657374436F6E7472616374004F626A656374006D657373616765496E64657800696E646578006765745F54657374427974654172726179007365745F5465737442797465417272617900746573744279746541727261790000002743006F006E0074007200610063007400200069006E0069007400690061007400650064002E00000B4F0077006E00650072000011540065007300740042006F006F006C000011540065007300740042007900740065000011540065007300740043006800610072000015540065007300740053007400720069006E00670000155400650073007400550049006E007400330032000013540065007300740049006E0074003300320000155400650073007400550049006E007400360034000013540065007300740049006E00740036003400001754006500730074004100640064007200650073007300001B540065007300740042007900740065004100720072006100790000175400650073007400550049006E00740031003200380000175400650073007400550049006E00740032003500360000194D006500730073006100670065005B007B0030007D005D0000117B0030007D003A0020007B0031007D00000000003EF8487F7FA70F43BFB52ADCC4057E2D0004200101080320000105200101111105200101121D04200012350420001121042000123905200111210E062002010E1121042001020E052002010E020520011D050E0407011D05062002010E1D05042001030E052002010E030420010E0E052002010E0E042001090E052002010E09042001080E052002010E080420010B0E052002010E0B0420010A0E052002010E0A05200111250E062002010E112505200111290E062002010E11290507020E110C0500020E0E1C06300101011E00040A01110C0600030E0E1C1C087CEC85D7BEA7798E02060802060E15200D01121D0205030E09080B0A11211D05112511290520010111210320000204200101020320000504200101050320000304200101030320000E042001010E032000090420010109032000080320000B042001010B0320000A042001010A0420001D05052001011D05042000112505200101112504200011290520010111290520020E080E04280011210328000203280005032800030328000E03280009032800080328000B0328000A0428001D05042800112504280011290801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000000401000000000000000000000000000000000000100000000000000000000000000000004831000000000000000000006231000000200000000000000000000000000000000000000000000054310000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000743100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000')


@pytest.fixture(scope='package')
def get_node_smart_contract_address():
    def _get_node_smart_contract_address(node: Union[CirrusMinerNode, CirrusNode]) -> Address:
        sc_address = node.smart_contract_wallet.account_addresses(wallet_name='Test')
        return sc_address[0]
    return _get_node_smart_contract_address


@pytest.fixture(scope='package')
def fund_smartcontract_address(get_node_smart_contract_address, send_a_transaction, get_node_address_with_balance):
    def _fund_smartcontract_address(node: Union[CirrusMinerNode, CirrusNode, CirrusUnity3DNode]) -> bool:
        sending_address = get_node_address_with_balance(node)
        receiving_address = get_node_smart_contract_address(node)
        assert send_a_transaction(
            node=node, sending_address=sending_address, wallet_name='Test',
            receiving_address=receiving_address, amount_to_send=Money(50), min_confirmations=0
        )
        return True
    return _fund_smartcontract_address


@pytest.fixture(scope='package')
def make_some_transactions_by_splitting(wait_and_clear_mempool):
    def _make_some_transactions_by_splitting(node: BaseNode) -> bool:
        node.wallet.split_coins(
            wallet_name='Test',
            account_name='account 0',
            wallet_password='password',
            total_amount_to_split=Money(5000),
            utxos_count=100
        )
        assert wait_and_clear_mempool()
        return True
    return _make_some_transactions_by_splitting


@pytest.fixture(scope='package')
def create_smart_contract_transaction(cirrusminer_node, apitestcontract_bytecode, get_node_address_with_balance) -> BuildContractTransactionModel:
    sending_address = get_node_address_with_balance(cirrusminer_node)
    response = cirrusminer_node.smart_contracts.build_and_send_create(
        wallet_name='Test',
        account_name='account 0',
        outpoints=None,
        amount=Money(0),
        fee_amount=Money(0.0001),
        password='password',
        contract_code=apitestcontract_bytecode,
        gas_price=1000,
        gas_limit=250000,
        sender=sending_address,
        parameters=[
            SmartContractParameter(value_type=SmartContractParameterType.Boolean, value=True),
            SmartContractParameter(value_type=SmartContractParameterType.Byte, value=b'\xff'),
            SmartContractParameter(value_type=SmartContractParameterType.Char, value='c'),
            SmartContractParameter(value_type=SmartContractParameterType.String, value='Stratis'),
            SmartContractParameter(value_type=SmartContractParameterType.UInt32, value=uint32(123)),
            SmartContractParameter(value_type=SmartContractParameterType.Int32, value=int32(-123)),
            SmartContractParameter(value_type=SmartContractParameterType.UInt64, value=uint64(456)),
            SmartContractParameter(value_type=SmartContractParameterType.Int64, value=int64(-456)),
            SmartContractParameter(value_type=SmartContractParameterType.Address, value=sending_address),
            SmartContractParameter(value_type=SmartContractParameterType.ByteArray, value=bytearray(b'\x04\xa6\xb9')),
            SmartContractParameter(value_type=SmartContractParameterType.UInt128, value=uint128(789)),
            SmartContractParameter(value_type=SmartContractParameterType.UInt256, value=uint256(987))
        ]
    )
    assert isinstance(response, BuildContractTransactionModel)
    return response


@pytest.fixture(scope='package')
def get_contract_create_trxid(cirrusminer_node, create_smart_contract_transaction, wait_and_clear_mempool) -> uint256:
    trx = create_smart_contract_transaction
    response = cirrusminer_node.smart_contract_wallet.send_transaction(transaction_hex=trx.hex)
    assert isinstance(response, WalletSendTransactionModel)
    assert wait_and_clear_mempool()
    return response.transaction_id


@pytest.fixture(scope='package')
def get_contract_setup_receipt(cirrusminer_node, get_contract_create_trxid) -> ReceiptModel:
    trxid = get_contract_create_trxid
    response = cirrusminer_node.smart_contracts.receipt(tx_hash=trxid)
    assert isinstance(response, ReceiptModel)
    return response


@pytest.fixture(scope='package')
def get_smart_contract_address(get_contract_setup_receipt) -> Address:
    receipt = get_contract_setup_receipt
    address = receipt.new_contract_address
    assert isinstance(address, Address)
    return address


@pytest.fixture(scope='package')
def create_smart_contract_transaction_unity(cirrusminerunity3d_node, apitestcontract_bytecode, get_node_address_with_balance) -> BuildContractTransactionModel:
    sending_address = get_node_address_with_balance(cirrusminerunity3d_node)
    response = cirrusminerunity3d_node.smart_contracts.build_and_send_create(
        wallet_name='Test',
        account_name='account 0',
        outpoints=None,
        amount=Money(0),
        fee_amount=Money(0.0001),
        password='password',
        contract_code=apitestcontract_bytecode,
        gas_price=1000,
        gas_limit=250000,
        sender=sending_address,
        parameters=[
            SmartContractParameter(value_type=SmartContractParameterType.Boolean, value=True),
            SmartContractParameter(value_type=SmartContractParameterType.Byte, value=b'\xff'),
            SmartContractParameter(value_type=SmartContractParameterType.Char, value='c'),
            SmartContractParameter(value_type=SmartContractParameterType.String, value='Stratis'),
            SmartContractParameter(value_type=SmartContractParameterType.UInt32, value=uint32(123)),
            SmartContractParameter(value_type=SmartContractParameterType.Int32, value=int32(-123)),
            SmartContractParameter(value_type=SmartContractParameterType.UInt64, value=uint64(456)),
            SmartContractParameter(value_type=SmartContractParameterType.Int64, value=int64(-456)),
            SmartContractParameter(value_type=SmartContractParameterType.Address, value=sending_address),
            SmartContractParameter(value_type=SmartContractParameterType.ByteArray, value=bytearray(b'\x04\xa6\xb9')),
            SmartContractParameter(value_type=SmartContractParameterType.UInt128, value=uint128(789)),
            SmartContractParameter(value_type=SmartContractParameterType.UInt256, value=uint256(987))
        ]
    )
    assert isinstance(response, BuildContractTransactionModel)
    return response


@pytest.fixture(scope='package')
def get_contract_create_trxid_unity(cirrusminerunity3d_node, create_smart_contract_transaction_unity, wait_and_clear_mempool) -> uint256:
    trx = create_smart_contract_transaction_unity
    response = cirrusminerunity3d_node.smart_contract_wallet.send_transaction(transaction_hex=trx.hex)
    assert isinstance(response, WalletSendTransactionModel)
    assert wait_and_clear_mempool()
    return response.transaction_id


@pytest.fixture(scope='package')
def get_contract_setup_receipt_unity(cirrusminerunity3d_node, get_contract_create_trxid_unity) -> ReceiptModel:
    trxid = get_contract_create_trxid_unity
    response = cirrusminerunity3d_node.smart_contracts.receipt(tx_hash=trxid)
    assert isinstance(response, ReceiptModel)
    return response


@pytest.fixture(scope='package')
def get_smart_contract_address_unity(get_contract_setup_receipt_unity) -> Address:
    receipt = get_contract_setup_receipt_unity
    address = receipt.new_contract_address
    assert isinstance(address, Address)
    return address
